{% extends "base_user.html" %}

{% block title %}
    <h1 class="text-3xl font-bold mb-6">Files | [[ organization.name ]]</h1>
{% endblock %}

{% block content %}
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        {% for category, message in messages %}
          <div class="alert alert-[[ category ]] mb-4 p-4 bg-blue-100 text-blue-700 rounded">[[ message ]]</div>
        {% endfor %}
      {% endif %}
    {% endwith %}

    <p class="text-sm text-gray-500 mb-4">These files are used to answer questions on KTDock, providing relevant information to enhance your knowledge base.</p>
    <table class="w-full bg-white shadow-md rounded mb-4">
      <thead>
        <tr class="bg-gray-200 text-gray-600 uppercase text-sm leading-normal">
          <th class="py-3 px-6 text-left">File Name</th>
          <th class="py-3 px-6 text-left">Upload Date</th>
          <th class="py-3 px-6 text-left">Size</th>
          <th class="py-3 px-6 text-left">Actions</th>
        </tr>
      </thead>
      <tbody class="text-gray-600 text-sm font-light">
        {% for file in files %}
        <tr class="border-b border-gray-200 hover:bg-gray-100">
          <td class="py-3 px-6 text-left whitespace-nowrap">
            <div class="flex items-center">
              <span class="font-medium">[[ file.file_name ]]</span>
            </div>
          </td>
          <td class="py-3 px-6 text-left">
            [[ file.timestamp_of_upload ]]
          </td>
          <td class="py-3 px-6 text-left">
            [[ file.file_size ]] bytes
          </td>
          <td class="py-3 px-6 text-left">
            <button onclick="previewFile('[[ file.id ]]')" class="text-blue-500 hover:text-blue-700">Preview</button>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>

    <!-- File Preview Overlay -->
    <div id="filePreviewOverlay" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full" style="display: none;">
        <div class="relative top-20 mx-auto p-5 border w-11/12 md:w-3/4 lg:w-1/2 shadow-lg rounded-md bg-white">
            <div class="mt-3 text-center">
                <h3 class="text-lg leading-6 font-medium text-gray-900" id="previewFileName"></h3>
                <div class="mt-2 px-7 py-3">
                    <pre id="fileContent" class="text-sm text-gray-500 whitespace-pre-wrap break-words max-h-96 overflow-y-auto"></pre>
                </div>
                <div class="items-center px-4 py-3">
                    <button id="closePreview" class="px-4 py-2 bg-blue-500 text-white text-base font-medium rounded-md shadow-sm hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-300">
                        Close
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        function previewFile(fileId) {
            fetch(`/preview-file/${fileId}`, {
                headers: {
                    'Login-Token': '[[ user.login_token ]]'
                }
            })
                .then(response => response.json())
                .then(data => {
                    document.getElementById('previewFileName').textContent = data.name;
                    document.getElementById('fileContent').textContent = data.content;
                    document.getElementById('filePreviewOverlay').style.display = 'block';
                })
                .catch(error => {
                    console.error('Error previewing file:', error);
                    alert('An error occurred while previewing the file.');
                });
        }

        document.getElementById('closePreview').addEventListener('click', function() {
            document.getElementById('filePreviewOverlay').style.display = 'none';
        });
    </script>
{% endblock %}