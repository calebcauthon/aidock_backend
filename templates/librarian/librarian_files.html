{% extends "base_librarian.html" %}

{% block content %}
<link href="https://unpkg.com/filepond@^4/dist/filepond.css" rel="stylesheet" />
<script src="https://unpkg.com/filepond@^4/dist/filepond.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.8.2/angular.min.js"></script>
<style>
    table {
        border-collapse: separate;
        border-spacing: 0;
        width: 100%;
    }
    th, td {
        padding: 12px 15px;
        text-align: left;
        border-bottom: 1px solid #e2e8f0;
    }
    th {
        background-color: #f8fafc;
        font-weight: bold;
        text-transform: uppercase;
        font-size: 0.75rem;
        letter-spacing: 0.05em;
        color: #4a5568;
    }
    tr:hover {
        background-color: #f7fafc;
    }
    tbody tr:last-child td {
        border-bottom: none;
    }
    .actions a {
        display: inline-block;
        padding: 4px 8px;
        border-radius: 4px;
        transition: background-color 0.2s;
    }
    .actions a:hover {
        background-color: #edf2f7;
    }
</style>

<div class="flex-1 p-8" ng-app="fileApp" ng-controller="FileController">
    <div class="flex justify-between items-center mb-8">
        <h2 class="text-2xl font-bold mb-6">Files</h2>
        <div class="flex items-center space-x-4">
            <div class="flex items-center space-x-2">
                <span>[[librarian['username']]] | [[organization['name']]]</span>
                <a href="[[ url_for('auth.logout') ]]" class="text-blue-500 hover:text-blue-700">Logout</a>
            </div>
        </div>
    </div>
    
    <div class="bg-white shadow-md rounded-lg p-6 mb-6">
        <form action="[[ url_for('librarian.upload_file') ]]" method="POST" enctype="multipart/form-data">
            <input type="file" name="file" multiple class="mb-4" />
        </form>
    </div>

    <div class="bg-white shadow-md rounded-lg p-6">
        <table class="w-full">
            <thead>
                <tr>
                    <th>File Name</th>
                    <th>Size</th>
                    <th>Upload Date</th>
                    <th>Uploaded By</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                <tr ng-repeat="file in files">
                    <td>
                        <span ng-hide="file.editing">{[{ file.name }]}</span>
                        <input ng-show="file.editing" type="text" ng-model="file.newName" class="border rounded px-2 py-1">
                    </td>
                    <td>{[{ formatFileSize(file.size) }]}</td>
                    <td>{[{ file.upload_date | date:'medium' }]}</td>
                    <td>{[{ file.user_name }]}</td>
                    <td>
                        <button ng-hide="file.editing" ng-click="startEditing(file)" class="text-blue-500 hover:text-blue-700 mr-2">Edit</button>
                        <button ng-show="file.editing" ng-click="saveEdit(file)" class="text-green-500 hover:text-green-700 mr-2">Save</button>
                        <button ng-show="file.editing" ng-click="cancelEdit(file)" class="text-gray-500 hover:text-gray-700 mr-2">Cancel</button>
                        <button ng-click="deleteFile(file.id)" class="text-red-500 hover:text-red-700">Delete</button>
                    </td>
                </tr>
            </tbody>
        </table>
    </div>

    <script>
        // Angular app
        angular.module('fileApp', [])
            .config(function($interpolateProvider) {
                $interpolateProvider.startSymbol('{[{');
                $interpolateProvider.endSymbol('}]}');
            })
            .controller('FileController', function($scope, $http) {
                $scope.files = [];

                $scope.refreshFiles = function() {
                    $http.get('/librarian/files')
                        .then(function(response) {
                            $scope.files = response.data;
                        }, function(error) {
                            console.error('Error fetching files:', error);
                        });
                };

                // Initial load of files
                $scope.refreshFiles();

                // FilePond initialization
                const inputElement = document.querySelector('input[type="file"]');
                const pond = FilePond.create(inputElement, {
                    server: '/librarian/upload',
                });

                document.addEventListener('FilePond:processfile', (e) => {
                  $scope.refreshFiles();
                });

                $scope.deleteFile = function(fileId) {
                    if (confirm('Are you sure you want to delete this file?')) {
                        $http.post('/librarian/delete_file/' + fileId)
                            .then(function(response) {
                                if (response.data.success) {
                                    $scope.refreshFiles();
                                } else {
                                    alert('Failed to delete file: ' + response.data.message);
                                }
                            }, function(error) {
                                console.error('Error deleting file:', error);
                                alert('An error occurred while deleting the file.');
                            });
                    }
                };

                $scope.startEditing = function(file) {
                    file.editing = true;
                    file.newName = file.name;
                };

                $scope.cancelEdit = function(file) {
                    file.editing = false;
                    file.newName = file.name;
                };

                $scope.saveEdit = function(file) {
                    $http.post('/librarian/edit_file/' + file.id, { new_filename: file.newName })
                        .then(function(response) {
                            if (response.data.success) {
                                file.name = file.newName;
                                file.editing = false;
                            } else {
                                alert('Failed to update file name: ' + response.data.message);
                            }
                        }, function(error) {
                            console.error('Error updating file name:', error);
                            alert('An error occurred while updating the file name.');
                        });
                };

                $scope.formatFileSize = function(bytes) {
                    if (bytes >= 1048576) {
                        return (bytes / 1048576).toFixed(2) + ' MB';
                    } else if (bytes >= 1024) {
                        return (bytes / 1024).toFixed(2) + ' KB';
                    } else {
                        return bytes + ' bytes';
                    }
                };

            });
    </script>
</div>
{% endblock %}